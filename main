// Function stuff
var maintainCreeps = require('func.maintainCreeps');
var maintainStructures = require('func.maintainStructures');
var maintainNexus = require('func.maintainNexus');
var statusReport = require('func.statusReport');

// Role Stuff
var roleHarvester = require('role.harvester');
var roleBuilder = require('role.builder');
var roleUpgrader = require('role.upgrader');
var roleRepairer = require('role.repairer');
var roleMiner = require('role.miner');
var roleTransfer = require('role.transfer');
var roleFiller = require('role.filler');
var roleTower = require('role.tower');
var roleFighter = require('role.fighter');
var roleHealer = require('role.healer');

module.exports.loop = function () {
    var startLoopTime = new Date().getTime();
    var startRoomLoopTime = new Date().getTime();
    for (var a in Game.rooms) {
        if (Game.rooms[a].find(FIND_MY_SPAWNS).length) {
            // Function for status report
            var startStatusReportTime = new Date().getTime();
            statusReport.run(Game.rooms[a]);
            var endStatusReportTime = new Date().getTime(); 
            
            // Function for creep maintenance
            var startCreepMainTime = new Date().getTime();
            maintainCreeps.run(Game.rooms[a]);
            var endCreepMainTime = new Date().getTime(); 
            
            // If statement to reduce resource consumption for building maintenance
            if (!(Game.time % 10)) {
                var startNexusMainTime = new Date().getTime();
                maintainNexus.run(Game.rooms[a]);
                var endNexusMainTime = new Date().getTime(); 
                
                var startStructMainTime = new Date().getTime();
                maintainStructures.run(Game.rooms[a]);
                var endStructMainTime = new Date().getTime(); 
            }
            
            // Tower AI Start
            var startTowerLoopTime = new Date().getTime();
            var towers = Game.rooms[a].find(FIND_STRUCTURES, {
                filter: (structure) => {
                    return structure.structureType == STRUCTURE_TOWER;
                }
            });
            
            for (let x in towers) {
                roleTower.run(towers[x]);
            }
            var endTowerLoopTime = new Date().getTime(); 
            // Tower AI end
            // Room Execution Time Report Start
            console.log("-===== ROOM EXECUTION TIMES =====-")
            console.log("Status Report - Start: " + startStatusReportTime + " | End: " + endStatusReportTime + " | Split: " + (endStatusReportTime - startStatusReportTime));
            if (!(Game.time % 10)) {
                console.log("Creep Management - Start: " + startCreepMainTime + " | End: " + endCreepMainTime + " | Split: " + (endCreepMainTime - startCreepMainTime));
                console.log("Nexus Management - Start: " + startNexusMainTime + " | End: " + endNexusMainTime + " | Split: " + (endNexusMainTime - startNexusMainTime));
            }
            console.log("Structure Management - Start: " + startStructMainTime + " | End: " + endStructMainTime + " | Split: " + (endStructMainTime - startStructMainTime));
            console.log("Tower AI Management - Start: " + startTowerLoopTime + " | End: " + endTowerLoopTime + " | Split: " + (endTowerLoopTime - startTowerLoopTime));
            // Room Execution Time Report End
        }
    }
    var endRoomLoopTime = new Date().getTime(); 
    
    // Unit AI start
    var startAILoopTime = new Date().getTime();
    for (var name in Game.creeps) {
        var creep = Game.creeps[name];
        //creep.suicide();
        if (creep.memory.role == 'healer') {
            roleHealer.run(creep);
        }
        if (creep.memory.role == 'fighter') {
            delete creep.memory.job;
            roleFighter.run(creep);
        }
        if (creep.memory.role == 'harvester') {
            // creep.suicide();
            roleHarvester.run(creep);
        }
        if (creep.memory.role == 'builder') {
            // creep.suicide();
            roleBuilder.run(creep);
        }
        if (creep.memory.role == 'upgrader') {
            roleUpgrader.run(creep);
        }
        if (creep.memory.role == 'repairer') {
            roleRepairer.run(creep);
            // creep.memory.job = false;
        }
        if (creep.memory.role == 'miner') {
            // creep.suicide();
            roleMiner.run(creep);
        }
        if (creep.memory.role == 'transfer') {
            // delete creep.memory.job;
            roleTransfer.run(creep);
            // creep.suicide();
        }
        if (creep.memory.role == 'filler') {
            // delete creep.memory.job;
            roleFiller.run(creep);
        }
        if (creep.memory.role == 'test pilot') {
            creep.moveTo(0,25);
        }
    }
    var endAILoopTime = new Date().getTime();
    // Unit AI end
    
    // Global Execution Time Report Start
    var endLoopTime = new Date().getTime();
    console.log("-====== GLOBAL EXECUTION TIME ======-");
    console.log("Room Management - Start: " + startRoomLoopTime + " | End: " + endRoomLoopTime + " | Split: " + (endRoomLoopTime - startRoomLoopTime));
    console.log("Creep AI Management - Start: " + startAILoopTime + " | End: " + endAILoopTime + " | Split: " + (endAILoopTime - startAILoopTime));
    console.log("Execution time - Start: " + startLoopTime + " | End:" + endLoopTime + " | Split: " + (endLoopTime - startLoopTime));
    // Global Execution Time Report End
}
